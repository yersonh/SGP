# Configuraci√≥n de alto rendimiento para sistema de votaciones
user www-data;
worker_processes auto;
worker_rlimit_nofile 65535;
pid /var/run/nginx.pid;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
    accept_mutex_delay 100ms;
}

http {
    # Configuraci√≥n b√°sica
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Logs espec√≠ficos para votaciones
    log_format votaciones_json escape=json '{'
        '"time_local":"$time_local",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"request":"$request",'
        '"status": "$status",'
        '"body_bytes_sent":"$body_bytes_sent",'
        '"request_time":"$request_time",'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent",'
        '"http_x_forwarded_for":"$http_x_forwarded_for",'
        '"server_name":"$server_name"'
    '}';
    
    access_log /var/log/nginx/votaciones-access.log votaciones_json buffer=32k flush=5s;
    error_log /var/log/nginx/votaciones-error.log warn;

    # üîê SECURIDAD - Headers obligatorios para gobierno
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Permitted-Cross-Domain-Policies "none" always;
    add_header Expect-CT "max-age=86400, enforce" always;

    # Optimizaciones de rendimiento
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 30s;
    keepalive_requests 1000;
    reset_timedout_connection on;
    client_body_timeout 10s;
    client_header_timeout 10s;
    send_timeout 10s;
    
    # Limites importantes para prevenir ataques
    client_max_body_size 10M;  # Suficiente para votaciones
    client_body_buffer_size 128k;
    client_header_buffer_size 3m;
    large_client_header_buffers 4 256k;
    
    # Rate limiting para prevenir fraude
    limit_req_zone $binary_remote_addr zone=votaciones_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/m;
    
    # Compresi√≥n GZIP
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json
        application/atom+xml
        image/svg+xml;

    # Cache optimizado
    open_file_cache max=10000 inactive=30s;
    open_file_cache_valid 60s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # üîí Configuraci√≥n principal del servidor de votaciones
    server {
        listen ${PORT} reuseport backlog=65535;
        listen [::]:${PORT} reuseport backlog=65535;
        server_name _;
        
        root /app/public;
        index index.php index.html index.htm;
        
        charset utf-8;
        
        # üîê SECURITY: Headers espec√≠ficos adicionales
        add_header X-Voting-System "Government-Secure" always;
        add_header X-Audit-Log "enabled" always;
        
        # Bloquear acceso a archivos sensibles
        location ~ /\.(git|svn|env|htaccess|htpasswd) {
            deny all;
            access_log off;
            log_not_found off;
            return 404;
        }
        
        location ~* \.(log|sql|bak|tar|gz)$ {
            deny all;
            access_log off;
            log_not_found off;
            return 404;
        }
        
        location ~* /(config|database|tests|vendor)/ {
            deny all;
            access_log off;
            log_not_found off;
            return 403;
        }
        
        # üìä Endpoint de monitoreo (solo desde localhost)
        location = /health {
            access_log off;
            allow 127.0.0.1;
            deny all;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $document_root/health-check.php;
            include fastcgi_params;
        }
        
        location = /metrics {
            access_log off;
            allow 127.0.0.1;
            deny all;
            return 200 "metrics_disabled\n";
        }
        
        # üó≥Ô∏è API de Votaciones - Rate limiting estricto
        location ~ ^/api/v1/vote {
            limit_req zone=votaciones_limit burst=20 nodelay;
            limit_req_status 429;
            
            # Validaciones adicionales
            if ($request_method !~ ^(POST|OPTIONS)$) {
                return 405;
            }
            
            # Solo contenido JSON aceptado
            if ($content_type !~ "application/json") {
                return 415;
            }
            
            try_files $uri @votaciones_php;
        }
        
        # üîê Autenticaci√≥n - Rate limiting m√°s estricto
        location ~ ^/api/v1/(auth|login|register) {
            limit_req zone=auth_limit burst=5 nodelay;
            limit_req_status 429;
            
            try_files $uri @votaciones_php;
        }
        
        # üìÅ Archivos est√°ticos con cache seguro
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|pdf)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options "nosniff";
            access_log off;
            
            # Solo archivos en public/
            try_files $uri =404;
        }
                # üìÅ SERVIR ARCHIVOS DESDE /uploads (Persistent Volume)
        location /uploads/ {
            alias /uploads/;
            expires 30d;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options "nosniff";
            access_log off;
            
            # üîê Seguridad - bloquear ejecuci√≥n de PHP en uploads
            location ~ \.php$ {
                deny all;
                return 403;
            }
            
            # Bloquear acceso a archivos ocultos
            location ~ /\. {
                deny all;
                return 403;
            }
            
            # Tipos MIME para im√°genes
            types {
                image/jpeg jpg jpeg;
                image/png png;
                image/gif gif;
                image/webp webp;
                image/svg+xml svg svgz;
            }
            
            try_files $uri =404;
        }
        
        # ‚ö†Ô∏è Deshabilitar m√©todos peligrosos
        if ($request_method ~ ^(TRACE|TRACK|DEBUG|DELETE)$) {
            return 405;
        }
        
        # Manejo de errores
        error_page 404 /error/404.html;
        error_page 500 502 503 504 /error/50x.html;
        
        location ^~ /error/ {
            internal;
        }
        
        # üêò PHP-FPM para procesamiento de votaciones
        location ~ \.php$ {
            # Seguridad adicional para PHP
            if ($uri !~ "^/index\.php") {
                return 403;
            }
            
            # Timeouts aumentados para procesamiento seguro
            fastcgi_connect_timeout 60s;
            fastcgi_send_timeout 300s;  # Para c√≥mputos largos
            fastcgi_read_timeout 300s;
            
            # Buffers optimizados
            fastcgi_buffer_size 128k;
            fastcgi_buffers 4 256k;
            fastcgi_busy_buffers_size 256k;
            fastcgi_temp_file_write_size 256k;
            
            # Configuraci√≥n est√°ndar
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_index index.php;
            
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            fastcgi_param QUERY_STRING $query_string;
            
            # üîê Headers de seguridad para PHP
            fastcgi_param HTTPS $http_x_forwarded_proto;
            fastcgi_param HTTP_X_FORWARDED_PROTO $http_x_forwarded_proto;
            fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
            fastcgi_param REMOTE_ADDR $http_x_real_ip;
            
            # Auditor√≠a
            fastcgi_param HTTP_X_VOTING_SESSION $http_x_voting_session;
            fastcgi_param HTTP_X_VOTER_ID $http_x_voter_id;
            
            include fastcgi_params;
        }
        
        location @votaciones_php {
            # Routing para SPA o APIs
            rewrite ^/(.*)$ /index.php?/$1 last;
        }
        
        # Redirecci√≥n principal
        location / {
            try_files $uri $uri/ /index.php?$query_string;
            
            # Headers de auditor√≠a
            add_header X-Voting-Request-ID $request_id;
            add_header X-Voting-Timestamp $msec;
        }
    }
}